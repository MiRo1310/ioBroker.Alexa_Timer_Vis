{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["\"use strict\";\nimport * as utils from \"@iobroker/adapter-core\";\n\nimport {\n\tdoesAlexaSendAQuestion,\n\tisIobrokerValue,\n\tisCreateNewTimer as isNewTimerAction,\n\tisStateChanged,\n\tisVoiceInputNotSameAsOld,\n} from \"./lib/global\";\nimport { timerObject } from \"./lib/timer-data\";\nimport { useStore } from \"./store/store\";\nimport { setAdapterStatusAndInitStateCreation } from \"./lib/set-adapter-status\";\nimport { getToDo } from \"./lib/get-todo\";\nimport { delTimer } from \"./lib/delete-timer\";\nimport { decomposeInputValue } from \"./lib/decompose-input-value\";\nimport { compareCreationTimeAndSerial } from \"./lib/compare-serial\";\nimport { shouldDelete } from \"./lib/check-voice-input\";\nimport { extendOrShortTimer } from \"./lib/timer-extend-or-shorten\";\nimport { timerDelete } from \"./lib/timer-delete\";\nimport { timerAdd } from \"./lib/timer-add\";\nimport { writeState } from \"./lib/write-state\";\nimport { getNewTimerName } from \"./lib/timer-name\";\nimport { resetAllTimerValuesAndState } from \"./lib/reset\";\n\nlet timeout_1: ioBroker.Timeout | undefined;\nlet debounceTimeout: ioBroker.Timeout | undefined;\n\nexport default class AlexaTimerVis extends utils.Adapter {\n\tprivate static instance: AlexaTimerVis;\n\t/**\n\t * @param {Partial<utils.AdapterOptions>} [options={}]\n\t */\n\tpublic constructor(options: Partial<utils.AdapterOptions> = {}) {\n\t\tsuper({\n\t\t\t...options,\n\t\t\tname: \"alexa-timer-vis\",\n\t\t});\n\t\tthis.on(\"ready\", this.onReady.bind(this));\n\t\tthis.on(\"unload\", this.onUnload.bind(this));\n\t\tAlexaTimerVis.instance = this;\n\t}\n\tpublic static getInstance(): AlexaTimerVis {\n\t\treturn AlexaTimerVis.instance;\n\t}\n\n\tprivate async onReady(): Promise<void> {\n\t\tconst store = useStore();\n\t\tstore._this = this;\n\n\t\tthis.setState(\"info.connection\", false, true);\n\n\t\tstore.pathAlexaSummary = `${this.config.alexa}.History.summary`;\n\n\t\tstore.intervalMore60 = this.config.intervall1;\n\t\tstore.intervalLess60 = this.config.intervall2;\n\n\t\tstore.unitHour1 = this.config.unitHour1;\n\t\tstore.unitHour2 = this.config.unitHour2;\n\t\tstore.unitHour3 = this.config.unitHour3;\n\t\tstore.unitMinute1 = this.config.unitMinute1;\n\t\tstore.unitMinute2 = this.config.unitMinute2;\n\t\tstore.unitMinute3 = this.config.unitMinute3;\n\t\tstore.unitSecond1 = this.config.unitSecond1;\n\t\tstore.unitSecond3 = this.config.unitSecond3;\n\t\tstore.unitSecond2 = this.config.unitSecond2;\n\n\t\tstore.valHourForZero = this.config.valHourForZero;\n\t\tstore.valMinuteForZero = this.config.valMinuteForZero;\n\t\tstore.valSecondForZero = this.config.valSecondForZero;\n\n\t\tstore.debounceTime = this.config.entprellZeit;\n\n\t\tawait setAdapterStatusAndInitStateCreation();\n\t\tresetAllTimerValuesAndState();\n\n\t\tlet voiceInputOld: null | string = null;\n\t\tlet voiceInput: string;\n\t\tlet timeVoiceInputOld: string | null = null;\n\n\t\tthis.on(\"stateChange\", async (id, state) => {\n\t\t\tcheckForTimerName(this);\n\n\t\t\tif (isStateChanged(state, id)) {\n\t\t\t\t// Bestimmte Aufrufe d\u00FCrfen keine Aktion ausf\u00FChren, wenn mehrere Ger\u00E4te zuh\u00F6ren. #12 und #14 .\n\t\t\t\tlet doNothingByNotNotedElement = false;\n\t\t\t\tvoiceInput = state?.val as string;\n\n\t\t\t\tif (timerObject.timerActive.data.notNotedSentence.find((el) => el === voiceInput)) {\n\t\t\t\t\tdoNothingByNotNotedElement = true;\n\t\t\t\t}\n\n\t\t\t\tif (isNewTimerAction(voiceInput)) {\n\t\t\t\t\tconst { varInputContainsDelete } = shouldDelete(voiceInput);\n\n\t\t\t\t\tconst {\n\t\t\t\t\t\tname: decomposeName,\n\t\t\t\t\t\ttimerSec,\n\t\t\t\t\t\tdeleteVal,\n\t\t\t\t\t\tinputString: decomposeInputString,\n\t\t\t\t\t} = await decomposeInputValue(voiceInput);\n\n\t\t\t\t\tconst { sameTime } = await compareCreationTimeAndSerial();\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t(!sameTime &&\n\t\t\t\t\t\t\tisVoiceInputNotSameAsOld(voiceInput, voiceInputOld) &&\n\t\t\t\t\t\t\t!doNothingByNotNotedElement &&\n\t\t\t\t\t\t\ttimeVoiceInputOld != timerSec.toString()) ||\n\t\t\t\t\t\tvarInputContainsDelete\n\t\t\t\t\t) {\n\t\t\t\t\t\tvoiceInputOld = voiceInput;\n\t\t\t\t\t\ttimeVoiceInputOld = timerSec.toString();\n\n\t\t\t\t\t\tthis.clearTimeout(debounceTimeout);\n\n\t\t\t\t\t\tdebounceTimeout = this.setTimeout(() => {\n\t\t\t\t\t\t\tvoiceInputOld = null;\n\t\t\t\t\t\t\ttimeVoiceInputOld = null;\n\t\t\t\t\t\t\tthis.log.debug(\"Reset ValueOld\");\n\t\t\t\t\t\t}, store.debounceTime * 1000);\n\n\t\t\t\t\t\tdoesAlexaSendAQuestion(voiceInput);\n\t\t\t\t\t\tgetToDo(voiceInput);\n\n\t\t\t\t\t\tif (store.isDeleteTimer()) {\n\t\t\t\t\t\t\ttimerDelete(decomposeName, timerSec, voiceInput, deleteVal);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (store.isAddTimer()) {\n\t\t\t\t\t\t\ttimerAdd(decomposeName, timerSec, decomposeInputString);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (store.isExtendTimer() || store.isShortenTimer()) {\n\t\t\t\t\t\t\textendOrShortTimer({ voiceInput, decomposeName });\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Auf Button reagieren\n\t\t\t} else if (\n\t\t\t\tid != `alexa-timer-vis.${this.instance}.info.connection` &&\n\t\t\t\tstate &&\n\t\t\t\tstate.val !== false &&\n\t\t\t\tid != \"alexa2.0.History.summary\"\n\t\t\t) {\n\t\t\t\ttry {\n\t\t\t\t\t// Aus ID den Timer erfassen\n\t\t\t\t\tconst timer = id.split(\".\")[2];\n\n\t\t\t\t\tconst timerOb = timerObject.timer[timer as keyof typeof timerObject.timer];\n\t\t\t\t\tlet alexaCommandState;\n\n\t\t\t\t\tif (timerOb?.serialNumber != undefined) {\n\t\t\t\t\t\talexaCommandState = `alexa2.${store.getAlexaInstanceObject().instance}.Echo-Devices.${timerOb.serialNumber}.Commands.textCommand`;\n\t\t\t\t\t\tlet name = \"\";\n\t\t\t\t\t\t// Wenn der Name ungleich nur \"Timer\" ist soll dieser mit ausgegeben werden\n\t\t\t\t\t\tif (timerOb.name != \"Timer\") name = timerOb.name;\n\n\t\t\t\t\t\t// TODO: Timer stoppen war vorher timerOb.inputString\n\t\t\t\t\t\tconst alexaTextToCommand = `stoppe ${name} ${timerOb.timerInput} Timer`;\n\t\t\t\t\t\t// Alexa State setzen, Alexa gibt dadurch eine Sprachausgabe\n\t\t\t\t\t\tdelTimer(timer as keyof typeof timerObject.timerActive.timer);\n\t\t\t\t\t\tthis.setForeignState(alexaCommandState, alexaTextToCommand, false);\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tthis.log.error(\"Serial Error: \" + JSON.stringify(e));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction checkForTimerName(_this: AlexaTimerVis): void {\n\t\t\t\tlet timerSelector = \"\";\n\t\t\t\tif (\n\t\t\t\t\tstore.lastTimers.find((el) => {\n\t\t\t\t\t\tif (el.id === id) {\n\t\t\t\t\t\t\ttimerSelector = el.timerSelector;\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t})\n\t\t\t\t) {\n\t\t\t\t\tif (isIobrokerValue(state)) {\n\t\t\t\t\t\tgetNewTimerName(state, timerSelector);\n\t\t\t\t\t}\n\n\t\t\t\t\tstore.lastTimers = store.lastTimers.filter((el) => el.id !== id);\n\t\t\t\t\t_this.unsubscribeForeignStatesAsync(id);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.subscribeForeignStates(store.pathAlexaSummary);\n\t}\n\n\tonUnload(callback: () => void): void {\n\t\tconst store = useStore();\n\t\ttry {\n\t\t\tthis.log.info(\"Adapter shuts down\");\n\n\t\t\twriteState(true);\n\n\t\t\tthis.clearTimeout(timeout_1);\n\t\t\tthis.clearTimeout(debounceTimeout);\n\n\t\t\tthis.clearInterval(store.interval);\n\n\t\t\tif (!timerObject.interval) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfor (const element in timerObject.interval) {\n\t\t\t\tthis.clearInterval(timerObject.interval[element as keyof typeof timerObject.interval]);\n\t\t\t}\n\n\t\t\tthis.log.debug(\"Intervals and timeouts cleared!\");\n\n\t\t\tcallback();\n\t\t} catch (e) {\n\t\t\tcallback();\n\t\t}\n\t}\n}\n\nlet adapter;\nif (require.main !== module) {\n\t// Export the constructor in compact mode\n\tadapter = (options: Partial<utils.AdapterOptions> | undefined) => new AlexaTimerVis(options);\n} else {\n\t// otherwise start the instance directly\n\t(() => new AlexaTimerVis())();\n}\nexport { adapter };\n"],
  "mappings": "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",
  "names": ["isNewTimerAction"]
}
